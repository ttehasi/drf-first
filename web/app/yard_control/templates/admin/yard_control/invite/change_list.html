{% extends "admin/change_list.html" %}

{% block extrahead %}
{{ block.super }}
<style>
/* Минимальные кастомные стили */
.modal-backdrop {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1040;
}

.modal-custom {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 20px;
    border-radius: 0.375rem;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    z-index: 1050;
    width: 500px;
    max-width: 95vw;
}

.modal-custom.show {
    display: block;
}

.modal-backdrop.show {
    display: block;
}

.upload-area {
    border: 2px dashed #dee2e6;
    border-radius: 0.375rem;
    padding: 2rem;
    text-align: center;
    background: #f8f9fa;
    cursor: pointer;
    margin: 1rem 0;
    transition: all 0.2s;
}

.upload-area:hover {
    border-color: #007bff;
    background: #e3f2fd;
}

.upload-area.dragover {
    border-color: #007bff;
    background: #bbdefb;
}

.file-name {
    margin-top: 0.5rem;
    font-weight: 500;
    color: #28a745;
}

.close-btn {
    background: none;
    border: none;
    font-size: 1.25rem;
    color: #6c757d;
    cursor: pointer;
    padding: 0.25rem;
    width: 2rem;
    height: 2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 0.25rem;
}

.close-btn:hover {
    background: #f8f9fa;
    color: #000;
}
</style>
{% endblock %}

{% block object-tools %}
<div class="object-tools">
    <!-- Кнопка открытия модального окна -->
    <button type="button" class="btn btn-primary mr-2" onclick="openModal()">
        <i class="fas fa-upload"></i> Загрузить приглашения из файла
    </button>

    {{ block.super }}
</div>

<!-- Модальное окно -->
<div class="modal-backdrop" id="modalBackdrop" onclick="closeModal()"></div>

<div class="modal-custom" id="uploadModal">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">
            <i class="fas fa-file-import text-primary"></i> Загрузка приглашений
        </h4>
        <button type="button" class="close-btn" onclick="closeModal()">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <form method="post" enctype="multipart/form-data" action="upload-file/" id="uploadForm">
        {% csrf_token %}
        
        <!-- Поле выбора двора -->
        <div class="mb-3">
            <label class="form-label">
                <i class="fas fa-building"></i> Выберите двор
            </label>
            <select name="yard" id="yard-select" class="form-select" required>
                <option value="">-- Выберите двор --</option>
                {% if user.is_superuser %}
                    {% for yard in yards_superuser %}
                        <option value="{{ yard.id }}">{{ yard.address }}</option>
                    {% endfor %}
                {% elif user.admin %}
                    {% for yard in yards_user %}
                        <option value="{{ yard.id }}">{{ yard.address }}</option>
                    {% endfor %}
                {% endif %}
            </select>
        </div>

        <!-- Область для drag&drop -->
        <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
            <div class="mb-2">
                <i class="fas fa-cloud-upload-alt fa-2x text-muted"></i>
            </div>
            <h5>Перетащите файл сюда</h5>
            <p class="text-muted">или кликните для выбора</p>
            <div id="fileName" class="file-name"></div>
        </div>

        <!-- Скрытое поле для файла -->
        <input type="file" name="file" id="fileInput" style="display: none;" required accept=".csv,.xlsx,.xls">

        <div class="d-flex justify-content-end gap-2 mt-3">
            <button type="button" class="btn btn-secondary mr-2" onclick="closeModal()">
                <i class="fas fa-times"></i> Отмена
            </button>
            <button type="submit" class="btn btn-success" id="submitBtn" disabled>
                <i class="fas fa-play"></i> Обработать файл
            </button>
        </div>
    </form>
</div>

<script>
let selectedFile = null;

function openModal() {
    document.getElementById('uploadModal').classList.add('show');
    document.getElementById('modalBackdrop').classList.add('show');
    document.body.style.overflow = 'hidden';
}

function closeModal() {
    document.getElementById('uploadModal').classList.remove('show');
    document.getElementById('modalBackdrop').classList.remove('show');
    document.body.style.overflow = '';
    resetForm();
}

function resetForm() {
    document.getElementById('uploadForm').reset();
    document.getElementById('fileName').textContent = '';
    document.getElementById('submitBtn').disabled = true;
    selectedFile = null;
}

// Drag & Drop функциональность
const uploadArea = document.getElementById('uploadArea');
const fileInput = document.getElementById('fileInput');

['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    uploadArea.addEventListener(eventName, preventDefaults, false);
});

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

['dragenter', 'dragover'].forEach(eventName => {
    uploadArea.addEventListener(eventName, highlight, false);
});

['dragleave', 'drop'].forEach(eventName => {
    uploadArea.addEventListener(eventName, unhighlight, false);
});

function highlight() {
    uploadArea.classList.add('dragover');
}

function unhighlight() {
    uploadArea.classList.remove('dragover');
}

uploadArea.addEventListener('drop', handleDrop, false);

function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    
    if (files.length > 0) {
        fileInput.files = files;
        handleFileSelect(files[0]);
    }
}

fileInput.addEventListener('change', function() {
    if (this.files.length > 0) {
        handleFileSelect(this.files[0]);
    }
});

function handleFileSelect(file) {
    selectedFile = file;
    document.getElementById('fileName').textContent = `✓ ${file.name}`;
    checkFormValidity();
}

function checkFormValidity() {
    const yardSelected = document.getElementById('yard-select').value !== '';
    const fileSelected = selectedFile !== null;
    document.getElementById('submitBtn').disabled = !(yardSelected && fileSelected);
}

document.getElementById('yard-select').addEventListener('change', checkFormValidity);

// Закрытие по ESC
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeModal();
    }
});

// Предотвращаем закрытие при клике на само модальное окно
document.getElementById('uploadModal').addEventListener('click', function(e) {
    e.stopPropagation();
});

{% if single_yard_id %}
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() {
        const yardSelect = document.querySelector('select[name="yard"]');
        if (yardSelect) {
            yardSelect.value = '{{ single_yard_id }}';
            {% if disable_yard_select %}
            yardSelect.disabled = true;
            
            // Добавляем скрытое поле чтобы значение передавалось при отправке формы
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'yard';
            hiddenInput.value = '{{ single_yard_id }}';
            yardSelect.parentNode.appendChild(hiddenInput);
            {% endif %}
        }
    }, 500);
});
{% endif %}

</script>
{% endblock %}